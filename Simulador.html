<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Planejador - Gestão Estratégica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; }
        .input-config { border: 1px solid #e2e8f0; border-radius: 8px; padding: 6px 10px; width: 100%; font-size: 11px; color: #0f172a; }
        .ideal-col { background-color: #f0fdf4; color: #166534; font-weight: 700; }
        @media print { .no-print { display: none !important; } #conteudo-pdf { box-shadow: none !important; border: none !important; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-8">
        
        <div class="no-print bg-white p-8 rounded-[2rem] shadow-sm border border-slate-200">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-black uppercase tracking-tighter text-slate-800">Painel de Controle</h2>
                    <p class="text-slate-400 text-sm italic">Simulada: Valor alvo baseado no patrimônio atual do cliente.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="adicionarNovoAtivo()" class="bg-slate-800 text-white px-5 py-2 rounded-xl font-bold hover:bg-slate-700 transition">+ Ativo</button>
                    <button onclick="gerarPDF()" class="bg-blue-600 text-white px-5 py-2 rounded-xl font-bold hover:bg-blue-700 transition">Gerar PDF</button>
                </div>
            </div>

            <div class="mb-8 p-4 bg-slate-50 rounded-xl border border-slate-200">
                <label class="block text-[10px] font-black text-slate-500 uppercase mb-2 tracking-widest">Nome do Cliente</label>
                <input type="text" id="nomeClienteInput" placeholder="Nome do Cliente..." oninput="atualizarNomeNoPdf()" 
                       class="w-full p-3 text-lg font-bold text-slate-800 bg-white border border-slate-300 rounded-xl outline-none">
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left text-[11px] text-slate-900">
                    <thead>
                        <tr class="font-black text-slate-400 uppercase tracking-widest border-b pb-4 text-slate-900">
                            <th class="p-2 w-32">Classe</th>
                            <th class="p-2 w-32">Ticker</th>
                            <th class="p-2">Preço (R$)</th>
                            <th class="p-2">Alvo %</th>
                            <th class="p-2">Atual (R$)</th>
                            <th class="p-2 bg-green-50 text-green-700">Simulada (Ideal)</th>
                            <th class="p-2">Ordem</th>
                            <th class="p-2 text-center">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaEdicao" class="divide-y divide-slate-50 text-slate-900"></tbody>
                </table>
            </div>
        </div>

        <div id="conteudo-pdf" class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-100">
            <div class="bg-slate-900 p-12 text-white flex justify-between items-end">
                <div>
                    <h1 class="text-4xl font-black tracking-tighter uppercase text-white">Mapa de Aporte</h1>
                    <div class="flex items-center gap-2 mt-2 text-white">
                        <p class="text-blue-400 font-bold uppercase text-xs tracking-[0.3em]">Relatório Estratégico |</p>
                        <p id="nomeClientePdf" class="text-white font-bold text-xs uppercase tracking-[0.2em] italic">Nome do Cliente</p>
                    </div>
                </div>
            </div>

            <div class="p-10 md:p-16 text-slate-900">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-16 text-slate-900">
                    <div class="p-8 bg-slate-50 rounded-3xl border border-slate-100">
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest text-slate-900">Aporte Definido para Hoje</label>
                        <input type="number" id="valorAporte" value="3000" oninput="calcularEAtualizar()" class="no-print w-full bg-transparent text-4xl font-black text-slate-900 focus:outline-none">
                        <span id="valorAporteDisplay" class="hidden text-4xl font-black text-slate-900"></span>
                    </div>
                    <div class="p-8 bg-slate-50 rounded-3xl border border-slate-100">
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest text-slate-900">Patrimônio Base</label>
                        <p id="totalPatrimonio" class="text-4xl font-black text-slate-900">R$ 0,00</p>
                    </div>
                </div>

                <div id="mapaRelatorio" class="space-y-12 text-slate-900"></div>

                <div class="mt-12 flex justify-between items-center p-8 bg-slate-900 rounded-3xl text-white">
                    <span class="text-lg font-bold uppercase tracking-widest text-blue-400">Total Recomendado para Execução:</span>
                    <span id="totalRecomendadoMapa" class="text-3xl font-black">R$ 0,00</span>
                </div>

                <div class="mt-8 p-6 bg-blue-50 rounded-2xl border-l-4 border-blue-500 text-slate-900">
                    <p class="text-blue-800 text-sm font-bold italic">
                        * Qualquer valor restante do aporte planejado deve ser direcionado para o Tesouro SELIC na Renda Fixa.
                    </p>
                </div>

                <div class="mt-16 p-10 bg-red-50 rounded-[2.5rem] border-2 border-red-100 text-slate-900">
                    <h3 class="text-red-600 font-black text-xs uppercase tracking-widest mb-4">Ajustes e Vendas Estratégicas</h3>
                    <textarea class="w-full bg-transparent border-none focus:ring-0 text-slate-700 italic text-lg leading-relaxed h-24" placeholder="Insira ordens de venda ou comentários adicionais aqui..."></textarea>
                </div>

                <div class="mt-12 p-12 bg-slate-900 rounded-[3rem] text-white">
                    <p class="text-slate-300 italic text-xl leading-relaxed opacity-80">
                        "O rebalanceamento é o mecanismo que protege seu futuro da ansiedade do presente. Siga o plano."
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ordemPrioridade = ['RENDA FIXA', 'FIIs', 'AÇÕES BR', 'INTERNACIONAL', 'ALTERNATIVOS'];

        let carteira = JSON.parse(localStorage.getItem('carteiraV5')) || [
            { classe: 'RENDA FIXA', ticker: 'TESOURO SELIC', preco: 1, alvo: 17, atual: 1258.12, rec: 'Comprar' },
            { classe: 'RENDA FIXA', ticker: 'JURO11', preco: 101.83, alvo: 7.5, atual: 292.68, rec: 'Comprar' },
            { classe: 'RENDA FIXA', ticker: 'FIXA11', preco: 18.64, alvo: 5, atual: 295.68, rec: 'Comprar' },
            { classe: 'RENDA FIXA', ticker: 'TESOURO IPCA+ 2050', preco: 1, alvo: 11, atual: 2262.73, rec: 'Comprar' },
            { classe: 'FIIs', ticker: 'PSEC11', preco: 64.30, alvo: 4, atual: 552.78, rec: 'Comprar' },
            { classe: 'FIIs', ticker: 'PVBI11', preco: 80.20, alvo: 4, atual: 719.82, rec: 'Comprar' },
            { classe: 'FIIs', ticker: 'CPTS11', preco: 7.83, alvo: 5, atual: 943.61, rec: 'Comprar' },
            { classe: 'FIIs', ticker: 'XPML11', preco: 109.45, alvo: 5.5, atual: 954.00, rec: 'Comprar' },
            { classe: 'AÇÕES BR', ticker: 'BBAS3', preco: 21.88, alvo: 6, atual: 571.22, rec: 'Comprar' },
            { classe: 'AÇÕES BR', ticker: 'WIZC3', preco: 9.03, alvo: 6, atual: 0, rec: 'Comprar' },
            { classe: 'AÇÕES BR', ticker: 'SAPR11', preco: 40.35, alvo: 6, atual: 498.26, rec: 'Manter' },
            { classe: 'INTERNACIONAL', ticker: 'WRLD11', preco: 140.08, alvo: 11, atual: 403.50, rec: 'Comprar' },
            { classe: 'INTERNACIONAL', ticker: 'USDB11', preco: 104.51, alvo: 6, atual: 313.65, rec: 'Comprar' },
            { classe: 'ALTERNATIVOS', ticker: 'GOLD11', preco: 25.06, alvo: 3, atual: 0, rec: 'Comprar' },
            { classe: 'ALTERNATIVOS', ticker: 'HODL11', preco: 82.13, alvo: 3, atual: 0, rec: 'Comprar' }
        ];

        function formatarMoeda(v) { return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }

        function atualizarNomeNoPdf() {
            document.getElementById('nomeClientePdf').textContent = document.getElementById('nomeClienteInput').value || "Nome do Cliente";
        }

        function adicionarNovoAtivo() {
            carteira.push({ classe: 'RENDA FIXA', ticker: 'NOVO', preco: 1, alvo: 0, atual: 0, rec: 'Comprar' });
            calcularEAtualizar();
        }

        function removerAtivo(idx) {
            carteira.splice(idx, 1);
            calcularEAtualizar();
        }

        function updateAtivo(idx, field, val) {
            carteira[idx][field] = (field === 'classe' || field === 'ticker' || field === 'rec') ? val : parseFloat(val);
            calcularEAtualizar();
        }

        function calcularEAtualizar() {
            localStorage.setItem('carteiraV5', JSON.stringify(carteira));
            const totalJaInvestido = carteira.reduce((sum, a) => sum + a.atual, 0);
            const aporteDisponivelBase = parseFloat(document.getElementById('valorAporte').value) || 0;
            const novoPatrimonioTotal = totalJaInvestido + aporteDisponivelBase;

            const tabelaEdicao = document.getElementById('tabelaEdicao');
            tabelaEdicao.innerHTML = '';
            carteira.forEach((ativo, idx) => {
                const valorIdealSimulado = totalJaInvestido * (ativo.alvo / 100);
                tabelaEdicao.innerHTML += `
                    <tr>
                        <td class="p-1"><input class="input-config" type="text" value="${ativo.classe}" onchange="updateAtivo(${idx}, 'classe', this.value)"></td>
                        <td class="p-1 font-bold"><input class="input-config" type="text" value="${ativo.ticker}" onchange="updateAtivo(${idx}, 'ticker', this.value)"></td>
                        <td class="p-1"><input class="input-config" type="number" value="${ativo.preco}" onchange="updateAtivo(${idx}, 'preco', this.value)"></td>
                        <td class="p-1"><input class="input-config" type="number" value="${ativo.alvo}" onchange="updateAtivo(${idx}, 'alvo', this.value)"></td>
                        <td class="p-1"><input class="input-config" type="number" value="${ativo.atual}" onchange="updateAtivo(${idx}, 'atual', this.value)"></td>
                        <td class="p-1 font-bold text-green-700 bg-green-50">${formatarMoeda(valorIdealSimulado)}</td>
                        <td class="p-1">
                            <select class="input-config" onchange="updateAtivo(${idx}, 'rec', this.value)">
                                <option value="Comprar" ${ativo.rec === 'Comprar' ? 'selected' : ''}>Comprar</option>
                                <option value="Manter" ${ativo.rec === 'Manter' ? 'selected' : ''}>Manter</option>
                                <option value="Vender" ${ativo.rec === 'Vender' ? 'selected' : ''}>Vender</option>
                            </select>
                        </td>
                        <td class="p-1 text-center"><button onclick="removerAtivo(${idx})" class="text-red-400 font-bold">✕</button></td>
                    </tr>
                `;
            });

            document.getElementById('totalPatrimonio').textContent = formatarMoeda(totalJaInvestido);
            document.getElementById('valorAporteDisplay').textContent = formatarMoeda(aporteDisponivelBase);
            
            const mapaRelatorio = document.getElementById('mapaRelatorio');
            mapaRelatorio.innerHTML = '';
            let somaTotalRecomendada = 0;
            let saldoRestanteCalculo = aporteDisponivelBase;
            const aporteFinalAtivos = {};

            // ALGORITMO HIERÁRQUICO
            ordemPrioridade.forEach(classe => {
                const ativosDaClasse = carteira.filter(a => a.classe === classe);
                ativosDaClasse.forEach(ativo => {
                    if (ativo.rec === 'Comprar' && saldoRestanteCalculo > 0) {
                        const valorAlvoPosAporte = novoPatrimonioTotal * (ativo.alvo / 100);
                        const gapFinan = valorAlvoPosAporte - ativo.atual;
                        
                        if (gapFinan > 0) {
                            let valorAporteItem = Math.min(gapFinan, saldoRestanteCalculo);
                            
                            if (ativo.ticker.includes("TESOURO")) {
                                aporteFinalAtivos[ativo.ticker] = { qtd: "Aporte Livre", subtotal: valorAporteItem };
                                saldoRestanteCalculo -= valorAporteItem;
                                somaTotalRecomendada += valorAporteItem;
                            } else {
                                let qtd = Math.floor(valorAporteItem / ativo.preco);
                                let subtotal = qtd * ativo.preco;
                                if (qtd > 0) {
                                    aporteFinalAtivos[ativo.ticker] = { qtd, subtotal };
                                    saldoRestanteCalculo -= subtotal;
                                    somaTotalRecomendada += subtotal;
                                }
                            }
                        }
                    }
                });
            });

            // RENDERIZAÇÃO MAPA
            ordemPrioridade.forEach(classe => {
                const ativosDaClasse = carteira.filter(a => a.classe === classe);
                if (ativosDaClasse.length === 0) return;

                let classeHtml = `
                    <div class="mb-6">
                        <h3 class="text-blue-600 font-black text-[10px] uppercase tracking-[0.2em] mb-4 flex items-center gap-4 text-slate-900">
                            ${classe} <span class="h-[1px] bg-blue-100 flex-1"></span>
                        </h3>
                        <table class="w-full text-slate-900">
                            <tbody class="divide-y divide-slate-50 text-slate-900">`;

                ativosDaClasse.forEach(ativo => {
                    const dados = aporteFinalAtivos[ativo.ticker];
                    let status = ativo.rec, cor = "bg-slate-100 text-slate-500", qtd = "--", valor = "--";

                    if (dados) {
                        status = "Comprar"; cor = "bg-green-100 text-green-700";
                        qtd = dados.qtd; valor = formatarMoeda(dados.subtotal);
                    } else if (ativo.rec === 'Vender') {
                        status = "Vender"; cor = "bg-red-100 text-red-700";
                    } else {
                        status = "Manter";
                    }

                    classeHtml += `
                        <tr class="text-slate-900">
                            <td class="py-4 font-black text-slate-800 text-lg">${ativo.ticker}</td>
                            <td class="text-center"><span class="${cor} text-[9px] font-black px-4 py-1.5 rounded-full uppercase text-slate-900">${status}</span></td>
                            <td class="text-center font-black text-slate-900">${qtd}</td>
                            <td class="text-right font-black text-slate-900 text-lg text-slate-900">${valor}</td>
                        </tr>`;
                });
                mapaRelatorio.innerHTML += classeHtml + `</tbody></table></div>`;
            });
            document.getElementById('totalRecomendadoMapa').textContent = formatarMoeda(somaTotalRecomendada);
        }

        function gerarPDF() {
            document.getElementById('valorAporteDisplay').classList.remove('hidden');
            const nomeCli = document.getElementById('nomeClienteInput').value || "Cliente";
            const element = document.getElementById('conteudo-pdf');
            html2pdf().set({
                margin: 0.2,
                filename: `Mapa_Aporte_${nomeCli}.pdf`,
                html2canvas: { scale: 3 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            }).from(element).save().then(() => {
                document.getElementById('valorAporteDisplay').classList.add('hidden');
            });
        }

        window.onload = calcularEAtualizar;
    </script>
</body>
</html>